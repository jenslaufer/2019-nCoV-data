---
title: "Prediction Coronvirus"
author: "Jens Laufer"
date: "2020/02/01"
output:
  md_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r}
library(tidyverse)
library(bbplot)
library(scales)
library(forecast)
library(tsbox)
library(lubridate)
```


```{r}
confirmed <- read_csv("data/Confirmed.csv") 
```






```{r}
confirmed <-
  confirmed %>% gather(
    -`Province/State`,
    -`Country/Region`,
    -`First confirmed date in country (Est.)`,
    -Lat,
    -Long,
    key = "date",
    value = "num"
  ) %>%
  mutate(
    num = replace_na(num, 0),
    `Province/State` = as.factor(`Province/State`),
    `Country/Region` = as.factor(`Country/Region`),
    `First confirmed date in country (Est.)` = as.Date(`First confirmed date in country (Est.)`, format =
                                                         "%m/%d/%Y"),
    datetime = as.POSIXct(date),
    date = as.Date(datetime)
  ) %>%
  group_by(`Province/State`, `Country/Region`, date) %>%
  top_n(1) %>%
  arrange(`Country/Region`, `Province/State`, datetime) %>%
  group_by(`Country/Region`, `Province/State`) %>%
  mutate(num_chg_pct = num / dplyr::lag(num)) %>%
  ungroup()
```



```{r fig.height=10, fig.width=20}
confirmed %>% group_by(datetime) %>% 
  summarise(total=sum(num)) %>% 
  ungroup() %>% 
  ggplot(aes(x=datetime, y=total)) +
  #geom_line()+
  geom_smooth() +
  bbc_style()
```


```{r fig.height=10, fig.width=20}
ts_c(confirmed %>% group_by(datetime) %>% 
  summarise(total=sum(num)) %>% 
  ungroup() %>% select(total)) %>% 
auto.arima() %>%
  forecast(h = 7) %>% 
  autoplot() +
  scale_y_continuous(labels = comma) +
  bbc_style()
```

```{r fig.height=20, fig.width=20}
confirmed %>% 
  group_by(`Country/Region`, datetime) %>%
  summarise(total=sum(num)) %>% 
  ungroup() %>% 
  ggplot(aes(x=datetime, y=total)) +
  geom_line()+
  geom_point(size=2)+
  facet_wrap(~`Country/Region`, scales = "free_y")+
  bbc_style()
  
```
```{r fig.height=20, fig.width=20}

confirmed %>% 
  filter(`Country/Region` == "Mainland China") %>% 
  group_by(`Province/State`, datetime) %>%
  summarise(total=sum(num)) %>% 
  ungroup() %>% 
  ggplot(aes(x=datetime, y=total)) +
  geom_line()+
  geom_point(size=2)+
  facet_wrap(~`Province/State`, scales = "free_y")+
  bbc_style()
  
```




```{r fig.height=20, fig.width=20}
confirmed %>% 
  filter(!is.nan(num_chg_pct)) %>% 
  filter(!is.infinite(num_chg_pct)) %>% 
  na.omit(num_chg_pct) %>% 
  filter(`Country/Region` == "Mainland China") %>% 
  ggplot(aes(x=date, y=num_chg_pct))+
  geom_bar(stat="identity") +
  facet_wrap(~`Province/State`) +
  bbc_style()
  
```
```{r}
confirmed %>% 
  filter(!is.nan(num_chg_pct)) %>% 
  filter(!is.infinite(num_chg_pct)) %>% 
  na.omit(num_chg_pct) %>% 
  filter(`Country/Region` == "Mainland China" &`Province/State` =="Hubei") %>% 
  ggplot(aes(x=date, y=num_chg_pct))+
  geom_bar(stat="identity") +
  facet_wrap(~`Province/State`)+
  bbc_style()
```


