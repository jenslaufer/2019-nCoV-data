---
title: "Google Mobilty"
author: "Jens Laufer"
date: "19 4 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r}
library(tidyverse)
library(glue)
library(ggthemes)
source("dataGather.R")
source("dataPreprocess.R")
```

```{r}
mobility.data <- load.mobility.google(F) 
```


```{r}
confirmed <- load.data.bno.news() %>% 
  preprocess.data() %>% 
  filter(type=="historical") %>% 
  select(name, date, diff) %>% 
  rename(country_region=name) %>% 
  na.omit() %>% 
  filter(!is.infinite(diff))
```



## Checking for missing values 



```{r}
mobility.data %>% 
  mutate(row=row_number()) %>% 
  gather(-row, key = "feature", value = "value") %>% 
  mutate(is_nan=is.na(value)) %>% 
  group_by(feature) %>% 
  mutate(total=n()) %>% 
  group_by(feature, is_nan, total) %>% 
  summarise(n=n()) %>%
  mutate(ratio=n/total, 
         ratio_pct=ifelse(is_nan==T, round(100*ratio,1), round(100*(1-ratio),1))) %>% 
  ungroup() %>%
  mutate(feature="{feature} ({ratio_pct}%)" %>% glue) %>% 
  select(-total, -n) %>% 
  ggplot(aes(x=feature, y=ratio, fill=is_nan)) +
  geom_bar(stat = "identity") +
  scale_fill_tableau() +
  coord_flip()

```




# Univariate Analysis



```{r fig.height=10, fig.width=20}
mobility.data %>% 
  select_if(is.numeric) %>% 
  gather(key = "feature", value = "value") %>% 
  ggplot(aes(x='', y=value)) +
  geom_boxplot() +
  coord_flip() +
  facet_wrap(~feature, scales = "free") 
```



## Multivariate Analysis

```{r}
mobility.data <- preprocess.mobility.data(mobility.data)
```



```{r fig.height=10, fig.width=20}

mobility.data.model.data <- (mobility.data %>% 
    group_by(country_region, sub_region_1) %>% fit.loess.model("overall_percent_change_from_baseline", "timestamp"))$data
mobility.data.model.data %>%
  filter(!is.na(overall_percent_change_from_baseline) &
           is.na(sub_region_1)) %>%
  filter(
    country_region == "France" |
      country_region == "Germany" |
      country_region == "Spain" |
      country_region == "United Kingdom" |
      country_region == "Italy" |
      country_region == "Sweden" |
      country_region == "United States"
  ) %>%
  ggplot(aes(x = date, y = fit, color =
               country_region)) +
  geom_line(aes(y = overall_percent_change_from_baseline)) +
  geom_line(size = 2) +
  geom_hline(yintercept = 0) +
  scale_color_tableau() +
  scale_x_date(date_breaks = "2 day") +
  facet_wrap( ~ country_region, scales = "free") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```




```{r}
cases.model.data <-  (confirmed %>% mutate(timestamp=as.numeric(as.POSIXct(date))) %>% 
  group_by(country_region) %>% fit.loess.model("diff", "timestamp"))$data
```




```{r}
filtered.confimed <- cases.model.data %>% 
  filter(
      country_region == "France" |
        country_region == "Germany" |
        country_region == "Spain" |
        country_region == "United Kingdom" |
        country_region == "Italy" |
        country_region == "United States") 
```

```{r}
filtered.mobility <- mobility.data %>% 
  filter(
      (country_region == "France" |
        country_region == "Germany" |
        country_region == "Spain" |
        country_region == "United Kingdom" |
        country_region == "Italy" |
        country_region == "United States") & is.na(sub_region_1)) %>% 
  select(country_region, date, overall_percent_change_from_baseline) 
```



```{r}
diff.mobility.scatter.plot <- function(data) {
  data %>%
    ggplot(aes(x = overall_percent_change_from_baseline, y = diff)) +
    geom_point() +
    facet_wrap(~country_region)
}
```


I filter all countries with significant decrease in mobility:

```{r}
mobility.chg <- mobility.data %>% 
  filter(is.na(sub_region_1) & !is.na(overall_percent_change_from_baseline)) %>% 
  select(country_region, date, overall_percent_change_from_baseline) %>% 
  arrange(country_region, -overall_percent_change_from_baseline) %>% 
  group_by(country_region) %>% 
  slice(1:1,n():n()) %>% 
  mutate(chg=overall_percent_change_from_baseline-lag(overall_percent_change_from_baseline)) %>% 
  na.omit() %>% 
  select(country_region, chg) %>% 
  arrange(chg) %>% 
  filter(chg < -70)
  
```




```{r fig.height=10, fig.width=20}

corr.data.model <- (
  seq(0, 30, 1) %>%
    map( ~ lag.data(filtered.confimed, filtered.mobility, ., "overall_percent_change_from_baseline")) %>%
    bind_rows() %>%
    group_by(country_region, lag) %>%
    summarise(cor = cor(
      diff, overall_percent_change_from_baseline
    )) %>%
    fit.loess.model("cor", "lag")
)$data

corr.data.model %>%
  ggplot(aes(x = lag, y = cor, color = country_region)) +
  geom_line() +
  geom_line(aes(y = fit), size = 2) +
  facet_wrap( ~ country_region) +
  scale_color_tableau()
```


```{r}
mobility.chg
```



```{r}
seq(0,30,1) %>% 
  map(~lag.data(confirmed %>% inner_join(mobility.chg), mobility.data %>% inner_join(mobility.chg), ., "overall_percent_change_from_baseline")) %>% 
  bind_rows() %>% 
  group_by(country_region, lag) %>% 
  summarise(cor=cor(diff, overall_percent_change_from_baseline)) %>% 
  ungroup() %>% 
  group_by(country_region) %>% 
  arrange(country_region, -cor) %>% 
  slice(1:1)  %>% 
  ungroup() %>% 
  ggplot(aes(x="", y=lag)) +
  geom_boxplot() +
  geom_jitter(alpha=0.3)
```

```{r fig.height=10, fig.width=20}
mobility.data.model.data %>% 
  mutate(date=date+14)%>%
  filter(!is.na(overall_percent_change_from_baseline) & is.na(sub_region_1)) %>% 
  filter(
    
      country_region == "France" |
        country_region == "Germany" |
        country_region == "Spain" |
        country_region == "United Kingdom" |
        country_region == "Italy" |
        country_region == "Sweden" |
        country_region == "United States"
    
    
  ) %>% 
  ggplot(aes(x=date, y=fit))+
  geom_line()+
  facet_wrap(~country_region,  scales="free") +
  scale_x_date(date_breaks = "2 day") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r fig.height=10, fig.width=20}
cases.model.data %>% 
  filter(
      country_region == "France" |
        country_region == "Germany" |
        country_region == "Spain" |
        country_region == "United Kingdom" |
        country_region == "Italy" |
        country_region == "Sweden" |
        country_region == "United States") %>% 
  group_by(country_region) %>% 
  ggplot(aes(x=date, y=fit, color=country_region)) +
  geom_line(size=2) + 
  geom_line(aes(y=diff)) +
  scale_color_tableau() +
  scale_x_date(date_breaks = "2 day") +
  facet_wrap( ~ country_region, scales="free") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

