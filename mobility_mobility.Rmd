---
title: "Google Mobilty"
author: "Jens Laufer"
date: "19 4 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r}
library(tidyverse)
library(glue)
library(ggthemes)
source("dataGather.R")

```

```{r}
mobility.data <- load.mobility.google()
```




## Checking for missing values 



```{r}

mobility.data %>% 
  mutate(row=row_number()) %>% 
  gather(-row, key = "feature", value = "value") %>% 
  mutate(is_nan=is.na(value)) %>% 
  group_by(feature) %>% 
  mutate(total=n()) %>% 
  group_by(feature, is_nan, total) %>% 
  summarise(n=n()) %>%
  mutate(ratio=n/total, 
         ratio_pct=ifelse(is_nan==T, round(100*ratio,1), round(100*(1-ratio),1))) %>% 
  ungroup() %>%
  mutate(feature="{feature} ({ratio_pct}%)" %>% glue) %>% 
  select(-total, -n) %>% 
  ggplot(aes(x=feature, y=ratio, fill=is_nan)) +
  geom_bar(stat = "identity") +
  scale_fill_tableau() +
  coord_flip()

mobility.data <- mobility.data %>% select(-sub_region_2)
  
```



# Univariate Analysis



```{r fig.height=10, fig.width=20}
mobility.data %>% 
  select_if(is.numeric) %>% 
  gather(key = "feature", value = "value") %>% 
  ggplot(aes(x='', y=value)) +
  geom_boxplot() +
  coord_flip() +
  facet_wrap(~feature, scales = "free") 
```



## Multivariate Analysis





```{r fig.height=10, fig.width=20}
mobility.data %>%
  mutate(
    timestamp = as.numeric(as.POSIXct(date)),
    overall_percent_change_from_baseline = (
      retail_and_recreation_percent_change_from_baseline + grocery_and_pharmacy_percent_change_from_baseline + parks_percent_change_from_baseline + transit_stations_percent_change_from_baseline + workplaces_percent_change_from_baseline + residential_percent_change_from_baseline
    ) / 6
  ) %>%
  select(
    country_region,
    date,
    timestamp,
    overall_percent_change_from_baseline,
    sub_region_1
  ) %>%
  filter(!is.na(overall_percent_change_from_baseline)) %>%
  group_by(country_region) %>%
  nest() %>%
  mutate(mdl = map(
    data,
    ~ loess(overall_percent_change_from_baseline ~ timestamp, data = .)
  ),
  fit = map(mdl, `[[`, "fitted")) %>%
  ungroup() %>%
  select(-mdl) %>%
  unnest() %>%
  filter(
    (
      country_region == "France" |
        country_region == "Germany" |
        country_region == "Spain" |
        country_region == "United Kingdom" |
        country_region == "Italy" |
        country_region == "United States"
    ) & !is.na(sub_region_1)
    
  ) %>%
  ggplot(aes(x = date, y = fit, color =
               country_region)) +
  geom_line(aes(y = overall_percent_change_from_baseline)) +
  geom_line(size=2) +
  geom_hline(yintercept = 0) +
  scale_color_tableau() +
  scale_x_date(date_breaks = "2 day") +
  facet_wrap(~ country_region) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```




```{r}
source("dataGather.R")
source("dataPreprocess.R")
```

```{r}
confirmed <- load.data.bno.news() %>% 
  preprocess.data() %>% 
  filter(type=="historical") %>% 
  select(name, date, diff) %>% 
  rename(country_region=name) %>% 
  na.omit() %>% 
  filter(!is.infinite(diff))
```






```{r}
models <- confirmed %>%
  mutate(timestamp=as.numeric(as.POSIXct(date))) %>% 
  group_by(country_region) %>%
  nest() %>%
  mutate(mdl = map(data, ~ loess(diff ~ timestamp, data = .))) %>%
  mutate(fit = map(mdl, `[[`, "fitted")) %>% 
  ungroup()
```






```{r fig.height=10, fig.width=20}
models %>% 
  select(-mdl) %>% 
  unnest() %>% 

  filter(
      country_region == "France" |
        country_region == "Germany" |
        country_region == "Spain" |
        country_region == "United Kingdom" |
        country_region == "Italy" |
        country_region == "United States") %>% 
  group_by(country_region) %>% 
  filter(country_region == "Italy") %>% 
  ggplot(aes(x=date, y=fit, color=country_region)) +
  geom_line(size=2) + 
  geom_line(aes(y=diff)) +
  scale_color_tableau() +
  scale_x_date(date_breaks = "2 day") +
  facet_wrap( ~ country_region, scales="free") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```




