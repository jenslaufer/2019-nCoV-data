---
title: "Untitled"
author: "Jens Laufer"
date: "5 3 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r}
library(tidyverse)
library(bbplot)
library(ggthemes)
library(ggrepel)
library(scales)
library(glue)
library(tsbox)
library(forecast)

source("dataGather.R")
source("dataPreprocess.R")
source("visualisations.R")
```



```{r}
hospital.beds <- load.hospital.beds()
population <- load.populations()
```



```{r}
data <- load.data.bno.news()  
```



```{r eval=T}
data.jhu <- get.data.jhu()
china.filtered <- data.jhu %>%
  filter(`Country/Region` == "China") %>%
  select(date, `Country/Region`, confirmed) %>%
  group_by(date, `Country/Region`) %>%
  summarise(confirmed = sum(confirmed)) %>%
  ungroup() %>%
  mutate(day = row_number(),  type = "historical") %>%
  rename(name = `Country/Region`, cases = `confirmed`) %>%
  ungroup()

data <- data %>% bind_rows(china.filtered)

rm(china.filtered)
rm(data.jhu)

```



```{r}
data <-  data %>% preprocess.data()
```

```{r}
data %>% 
  filter(name=="Italy" | name=="Germany" | name=="Spain" | name=="France" | name=="China") %>% 
  filter(day==17)
```


```{r}
data %>% filter(name=="Italy" & type=="historical") %>% 
  select(name, date, cases, day, diff) %>% 
  tail(10) %>% 
  ggplot(aes(x=date, y=diff))+
  geom_bar(stat="identity") +
  geom_smooth(
      
  )
  
```








```{r fig.height=15, fig.width=30}
data %>%
  filter(
    name == "Germany" |
      name == "South Korea" |
      name == "France" |
      name == "China" |
      name == "Italy" |
      name == "United States" |
      name == "Iran" |
      name == "United Kingdom" |
      name == "Spain" |
      name == "Japan" |
      name == "Canada" |
      name == "Netherlands" |
      name == "Sweden" |
      name == "Switzerland"
  ) %>%
  cases.timelime()
```





```{r fig.height=10, fig.width=20}
plot <- data %>% 
  filter(date < today()) %>% 
  filter(
      name == "Germany" |
      name == "Spain" |
      name == "Italy" |
      name == "France" 
  ) %>% 
  filter(type=="historical") %>% 
  cases.timelime() %>% 
  german() +
  scale_y_continuous()+
  coord_cartesian(xlim=c(9,18))
plot
```

```{r fig.height=10, fig.width=20}
finalise_plot(plot, source_name = "Source: Jens Laufer (http://jenslaufer.com) Data: BNO News", 
              save_filepath = "case_compare.png",
              width_pixels = 2000, height_pixels = 1000)

```


```{r}
data %>% 
  filter(date<as.Date("2020-03-18")) %>%  
  group_by(day) %>% 
  slice(n()) %>% 
  filter(
      name == "Germany" |
      name == "Spain" |
      name == "Italy" |
      name == "United Kingdom" |
      name == "France" 
  ) 
  
```
```{r fig.height=10, fig.width=20}
data %>% 
  filter(
      name == "South Korea" |
      name == "Iran" |
      name == "Germany" 
  ) %>% 
  filter(type=="historical") %>% 
  cases.timelime() 
```




```{r fig.height=15, fig.width=30}
data %>% 
  filter(
      name == "South Korea" |
      name == "Iran" |
      name == "Spain" |
      name == "Italy"  
  ) %>% 
  cases.timelime() 


```


```{r fig.height=10, fig.width=20}
data %>% 
  filter(type=="historical") %>% 
  group_by(name) %>% 
  arrange(cases) %>% 
  slice(n()) %>% 
  left_join(hospital.beds) %>% 
  left_join(population) %>% 
  mutate(cases.per.1M.inhabitants=cases/population.mio) %>% 
  select(name, beds.per.1M.inhabitants, cases.per.1M.inhabitants, cases) %>% 
  ggplot(aes(x=beds.per.1M.inhabitants, y=cases.per.1M.inhabitants)) +
  geom_point(aes(size=cases))+
  geom_label_repel(aes(label=name)) +
  scale_x_log10()+
  scale_y_log10(label=comma)+
  bbc_style()
```
```{r fig.height=10, fig.width=20}
data %>%
  filter(type == "historical") %>%
  group_by(name) %>%
  arrange(cases) %>%
  slice(n()) %>%
  left_join(hospital.beds) %>%
  left_join(population) %>%
  mutate(cases.per.1M.inhabitants = cases / population.mio) %>%
  mutate(risk = cases.per.1M.inhabitants / beds.per.1M.inhabitants) %>%
  select(name, risk) %>%
  na.omit() %>% 
  ggplot(aes(x = reorder(name, risk), risk)) +
  geom_bar(stat = "identity", fill="steelblue") +
  coord_flip() 
```


```{r fig.height=10, fig.width=20}
data %>% 
  filter(
      name == "Germany" |
      name == "Spain" |
      name == "Italy" |
      name == "United Kingdom" |
      name == "France" 
  ) %>% 
  filter(type=="historical") %>% 
  cases.timelime(.trans="identity") %>% german()
```

```{r}
data %>% 
  filter(name == "Germany" |
           name== "Italy" |
           name == "Spain" |
           name== "France"
           ) %>% 
  filter(day == 16)
```

